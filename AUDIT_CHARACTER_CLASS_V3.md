# Audit de la classe Character - Version 3
**Date**: $(date)
**Lignes de code**: 1998 lignes

## üìä Vue d'ensemble

La classe `Character` est la classe centrale pour la gestion des personnages joueurs (PJ) dans le syst√®me D&D. Elle a subi plusieurs refactorings pour am√©liorer la coh√©rence orient√©e objet.

### Statistiques
- **M√©thodes publiques**: 66
- **M√©thodes priv√©es**: 2 (`hydrate`, `generateBaseCapabilities`, `calculateLevelFromExperience`)
- **M√©thodes statiques**: 4 (`create`, `findById`, `findByUserId`, `getCharactersByUser`, `getByUserId`)
- **M√©thodes d'instance**: 62
- **Propri√©t√©s publiques**: 45+

---

## üîç Analyse d√©taill√©e des m√©thodes

### M√©thodes de base (CRUD)

#### ‚úÖ M√©thodes statiques de cr√©ation/recherche
1. **`create(array $data, PDO $pdo = null)`** - Cr√©ation d'un personnage ‚úÖ **Utilis√©e**
2. **`findById($id, PDO $pdo = null)`** - Recherche par ID ‚úÖ **Tr√®s utilis√©e**
3. **`findByUserId($userId, PDO $pdo = null)`** - Recherche par utilisateur ‚úÖ **Utilis√©e**
4. **`getCharactersByUser($userId, $equippedOnly, PDO $pdo)`** - Liste des personnages avec filtre ‚úÖ **Utilis√©e**
5. **`getByUserId($userId, PDO $pdo = null)`** - Liste simple par utilisateur ‚ö†Ô∏è **Doublon potentiel avec `findByUserId`**

#### ‚úÖ M√©thodes d'instance de modification
6. **`update(array $data)`** - Mise √† jour ‚úÖ **Utilis√©e**
7. **`delete()`** - Suppression simple ‚úÖ **Utilis√©e**
8. **`deleteCompletely()`** - Suppression compl√®te avec donn√©es associ√©es ‚úÖ **Utilis√©e**

---

### M√©thodes de calcul et caract√©ristiques

#### ‚úÖ Modificateurs de caract√©ristiques
9. **`getProficiencyBonus()`** - Bonus de comp√©tence ‚úÖ **Utilis√©e**
10. **`getAbilityModifier($ability)`** - Modificateur g√©n√©rique ‚úÖ **Utilis√©e**
11. **`getStrengthModifier()`** - Modificateur de force ‚úÖ **Utilis√©e**
12. **`getDexterityModifier()`** - Modificateur de dext√©rit√© ‚úÖ **Utilis√©e**
13. **`getConstitutionModifier()`** - Modificateur de constitution ‚úÖ **Utilis√©e**
14. **`getIntelligenceModifier()`** - Modificateur d'intelligence ‚úÖ **Utilis√©e**
15. **`getWisdomModifier()`** - Modificateur de sagesse ‚úÖ **Utilis√©e**
16. **`getCharismaModifier()`** - Modificateur de charisme ‚úÖ **Utilis√©e**
17. **`getMyTotalAbilities()`** - Caract√©ristiques totales (base + race + am√©liorations + √©quipement + temporaires) ‚úÖ **Utilis√©e**
18. **`getMyAbilityModifiers()`** - Modificateurs bas√©s sur caract√©ristiques totales ‚úÖ **Utilis√©e**

#### ‚úÖ Points de vie et exp√©rience
19. **`calculateMaxHitPoints()`** - Calcul des PV max ‚úÖ **Probablement utilis√©e**
20. **`updateHitPoints($newHitPoints)`** - Mise √† jour des PV ‚úÖ **Utilis√©e**
21. **`updateExperiencePoints($newExperiencePoints)`** - Mise √† jour de l'XP ‚úÖ **Utilis√©e**
22. **`calculateLevelFromExperience($xp)`** - Calcul du niveau depuis XP ‚ö†Ô∏è **Priv√©e, usage interne**

#### ‚úÖ Classe d'armure
23. **`getCA()`** - Calcul de la classe d'armure ‚úÖ **Utilis√©e**

---

### M√©thodes de sorts et magie

#### ‚úÖ Gestion des sorts
24. **`getCharacterSpells()`** - Liste des sorts du personnage ‚úÖ **Utilis√©e**
25. **`getSpells()`** - Liste des sorts (alternative) ‚ö†Ô∏è **Potentiellement redondante avec `getCharacterSpells()`**
26. **`addSpell($spellId, $prepared, $known)`** - Ajouter un sort ‚úÖ **Utilis√©e**
27. **`removeSpell($spellId)`** - Retirer un sort ‚úÖ **Utilis√©e**

#### ‚úÖ Gestion des emplacements de sorts
28. **`getSpellSlotsUsage()`** - Usage des emplacements de sorts ‚úÖ **Utilis√©e**
29. **`useSpellSlot($level)`** - Utiliser un emplacement ‚úÖ **Utilis√©e**
30. **`freeSpellSlot($level)`** - Lib√©rer un emplacement ‚úÖ **Utilis√©e**
31. **`resetSpellSlotsUsage()`** - R√©initialiser l'usage ‚úÖ **Utilis√©e**
32. **`canCastSpells()`** - V√©rifier si le personnage peut lancer des sorts ‚úÖ **Utilis√©e**

---

### M√©thodes d'√©quipement

#### ‚úÖ Gestion de l'√©quipement
33. **`getCharacterEquipment()`** - √âquipement complet du personnage ‚úÖ **Utilis√©e**
34. **`getEquipment()`** - √âquipement sous forme d'objets Item ‚úÖ **Utilis√©e**
35. **`getEquippedItems()`** - Items √©quip√©s (ancienne table) ‚ö†Ô∏è **Utilise l'ancienne table `character_equipment`**
36. **`equipItem($itemName, $itemType, $slot)`** - √âquiper un objet ‚úÖ **Utilis√©e**
37. **`unequipItem($itemName)`** - D√©s√©quiper un objet ‚úÖ **Utilis√©e**
38. **`getMyEquippedArmor()`** - Armure √©quip√©e ‚úÖ **Utilis√©e**
39. **`getMyEquippedShield()`** - Bouclier √©quip√© ‚úÖ **Utilis√©e**
40. **`getMyEquipmentBonuses()`** - Bonus d'√©quipement ‚úÖ **Utilis√©e**
41. **`getStartingEquipmentCount()`** - Nombre d'objets d'√©quipement de d√©part ‚úÖ **Utilis√©e**

---

### M√©thodes de rage (Barbare)

#### ‚úÖ Gestion de la rage
42. **`getRageUsage()`** - Usage de la rage ‚úÖ **Utilis√©e**
43. **`useRage()`** - Utiliser la rage ‚úÖ **Utilis√©e**
44. **`freeRage()`** - Lib√©rer la rage ‚úÖ **Utilis√©e**
45. **`resetRageUsage()`** - R√©initialiser la rage ‚úÖ **Utilis√©e**
46. **`isBarbarian()`** - V√©rifier si barbare ‚úÖ **Utilis√©e**
47. **`getMyRageData()`** - Donn√©es compl√®tes de rage ‚úÖ **Utilis√©e**

---

### M√©thodes de capacit√©s

#### ‚úÖ Gestion des capacit√©s
48. **`getCapabilities()`** - Liste des capacit√©s ‚úÖ **Utilis√©e**
49. **`generateBaseCapabilities()`** - G√©n√©rer les capacit√©s de base ‚ö†Ô∏è **Priv√©e, usage interne**
50. **`addCapability($capabilityId, $source, $sourceId)`** - Ajouter une capacit√© ‚úÖ **Probablement utilis√©e**
51. **`removeCapability($capabilityId)`** - Retirer une capacit√© ‚úÖ **Probablement utilis√©e**

---

### M√©thodes d'am√©liorations de caract√©ristiques

#### ‚úÖ Gestion des am√©liorations
52. **`getAbilityImprovements()`** - Am√©liorations actuelles ‚úÖ **Utilis√©e**
53. **`saveAbilityImprovements($improvements)`** - Sauvegarder les am√©liorations ‚úÖ **Utilis√©e**
54. **`calculateFinalAbilities($abilityImprovements)`** - Calculer les caract√©ristiques finales ‚úÖ **Utilis√©e**

---

### M√©thodes de comp√©tences et langues

#### ‚úÖ G√©n√©ration de comp√©tences
55. **`generateFixedSkills()`** - Comp√©tences obligatoires ‚úÖ **Utilis√©e lors de la cr√©ation**
56. **`generateSkillChoices()`** - Comp√©tences au choix ‚úÖ **Utilis√©e lors de la cr√©ation**
57. **`generateBaseLanguages()`** - ‚ö†Ô∏è **M√©thode r√©f√©renc√©e mais non d√©finie dans la classe**

---

### M√©thodes de relations

#### ‚úÖ Relations avec autres entit√©s
58. **`belongsToUser($userId)`** - V√©rifier l'appartenance ‚úÖ **Utilis√©e**
59. **`getRace()`** - Obtenir l'objet Race ‚úÖ **Utilis√©e**
60. **`getClass()`** - Obtenir l'objet Classe ‚úÖ **Utilis√©e**
61. **`getArchetype()`** - Obtenir l'archetype ‚úÖ **Utilis√©e**
62. **`getCampaignInfo()`** - Informations de campagne ‚úÖ **Probablement utilis√©e**
63. **`isApprovedInCampaign()`** - V√©rifier l'approbation en campagne ‚úÖ **Utilis√©e**

---

### M√©thodes de poisons

#### ‚úÖ Gestion des poisons
64. **`getCharacterPoisons()`** - Liste des poisons ‚úÖ **Utilis√©e**
65. **`getMyCharacterPoisons()`** - Alias de `getCharacterPoisons()` ‚ö†Ô∏è **Redondante**

---

### M√©thodes de profil

#### ‚úÖ Gestion du profil
66. **`updateProfilePhoto($photoPath)`** - Mettre √† jour la photo ‚úÖ **Utilis√©e**

---

### M√©thodes de combat

#### ‚úÖ Calculs de combat
67. **`calculateMyCharacterAttacks()`** - Calculer les attaques ‚úÖ **Utilis√©e**
68. **`getMyTemporaryBonuses()`** - Bonus temporaires ‚úÖ **Utilis√©e**

---

### Getters simples

#### ‚úÖ Getters de base
69. **`getId()`** - ID du personnage ‚ö†Ô∏è **Redondant (propri√©t√© publique)**
70. **`getUserId()`** - ID utilisateur ‚ö†Ô∏è **Redondant (propri√©t√© publique)**
71. **`getClassId()`** - ID classe ‚ö†Ô∏è **Redondant (propri√©t√© publique)**
72. **`getIsEquipped()`** - Statut √©quip√© ‚ö†Ô∏è **Redondant (propri√©t√© publique)**

---

## ‚ö†Ô∏è Probl√®mes identifi√©s

### 1. Redondances

#### M√©thodes redondantes
- **`getMyCharacterPoisons()`** et **`getCharacterPoisons()`** : `getMyCharacterPoisons()` est un simple alias
- **`getByUserId()`** et **`findByUserId()`** : Fonctionnalit√© similaire, √† v√©rifier si diff√©rence justifi√©e
- **`getSpells()`** et **`getCharacterSpells()`** : Deux m√©thodes qui semblent faire la m√™me chose
- **Getters redondants** : `getId()`, `getUserId()`, `getClassId()`, `getIsEquipped()` alors que les propri√©t√©s sont publiques

#### Code dupliqu√©
- Plusieurs m√©thodes utilisent des patterns similaires pour r√©cup√©rer des donn√©es depuis la base

### 2. M√©thodes manquantes

- **`generateBaseLanguages()`** : R√©f√©renc√©e dans `create()` (ligne 138) mais non d√©finie dans la classe

### 3. M√©thodes utilisant des tables obsol√®tes

- **`getEquippedItems()`** : Utilise l'ancienne table `character_equipment` au lieu de `items`

### 4. Incoh√©rences de design

#### M√©lange de styles de nommage
- Certaines m√©thodes commencent par `get` (ex: `getCharacterSpells()`)
- D'autres par `getMy` (ex: `getMyTotalAbilities()`, `getMyRageData()`)
- D'autres encore sans pr√©fixe (ex: `updateHitPoints()`)

#### Utilisation de PDO
- Certaines m√©thodes utilisent `$this->pdo`
- D'autres utilisent `\Database::getInstance()->getPdo()`
- Incoh√©rence dans la gestion de la connexion PDO

### 5. M√©thodes priv√©es manquantes/utilis√©es

- **`hydrate()`** : Priv√©e, utilis√©e dans le constructeur ‚úÖ
- **`generateBaseCapabilities()`** : Priv√©e, utilis√©e dans `getCapabilities()` ‚úÖ
- **`calculateLevelFromExperience()`** : Priv√©e mais jamais appel√©e ‚ö†Ô∏è

---

## üìã Recommandations

### Priorit√© haute

1. **Supprimer les redondances** :
   - Supprimer `getMyCharacterPoisons()` et utiliser uniquement `getCharacterSpells()`
   - V√©rifier et fusionner `getByUserId()` et `findByUserId()` si identiques
   - V√©rifier et fusionner `getSpells()` et `getCharacterSpells()` si identiques
   - Supprimer les getters redondants (`getId()`, `getUserId()`, `getClassId()`, `getIsEquipped()`)

2. **Impl√©menter la m√©thode manquante** :
   - Cr√©er `generateBaseLanguages()` ou corriger l'appel dans `create()`

3. **Mettre √† jour `getEquippedItems()`** :
   - Migrer vers l'utilisation de la table `items` ou marquer comme obsol√®te

### Priorit√© moyenne

4. **Uniformiser le style de nommage** :
   - Choisir un pr√©fixe coh√©rent (`get` vs `getMy` vs sans pr√©fixe)
   - Appliquer la convention choisie partout

5. **Uniformiser l'utilisation de PDO** :
   - Utiliser syst√©matiquement `$this->pdo` dans les m√©thodes d'instance
   - √âviter les appels directs √† `\Database::getInstance()->getPdo()`

6. **V√©rifier l'utilisation de `calculateLevelFromExperience()`** :
   - Si non utilis√©e, la supprimer
   - Si n√©cessaire, la rendre publique ou l'int√©grer dans une m√©thode publique

### Priorit√© basse

7. **Documentation** :
   - Am√©liorer la documentation PHPDoc pour toutes les m√©thodes
   - Ajouter des exemples d'utilisation pour les m√©thodes complexes

8. **Tests** :
   - Cr√©er des tests unitaires pour toutes les m√©thodes publiques
   - V√©rifier les cas limites et les erreurs

---

## üîÑ √âvolutions depuis la derni√®re version

### M√©thodes d√©plac√©es vers d'autres classes

‚úÖ **D√©plac√©es vers `Classe.php`** :
- `getSpellCapabilities()` ‚Üí `Classe::getSpellCapabilities()`
- `getSpellsForClass()` ‚Üí `Classe::getSpells()`
- `addSpellToCharacter()` ‚Üí `Classe::addSpellToCharacter()`
- `removeSpellFromCharacter()` ‚Üí `Classe::removeSpellFromCharacter()`
- `updateSpellPrepared()` ‚Üí `Classe::updateSpellPrepared()`
- `getSpellSlotsUsageStatic()` ‚Üí `Classe::getSpellSlotsUsage()`
- `getMaxRages()` ‚Üí `Classe::getMaxRages()`
- `getArchetypeById()` ‚Üí `Classe::getArchetypeById()`
- `getArchetypeTypeStatic()` ‚Üí `Classe::getArchetypeType()`

‚úÖ **D√©plac√©es vers `Item.php`** :
- `getPoisonInfo()` ‚Üí `Item::getPoisonInfo()`

### M√©thodes converties en m√©thodes d'instance

‚úÖ **Converties de statique vers instance** :
- `useSpellSlotStatic()` ‚Üí `useSpellSlot()`
- `freeSpellSlotStatic()` ‚Üí `freeSpellSlot()`
- `resetSpellSlotsUsageStatic()` ‚Üí `resetSpellSlotsUsage()`
- `useRageStatic()` ‚Üí `useRage()`
- `freeRageStatic()` ‚Üí `freeRage()`
- `resetRageUsageStatic()` ‚Üí `resetRageUsage()`
- `unequipItemStatic()` ‚Üí `unequipItem()`
- `updateHitPoints()` ‚Üí M√©thode d'instance
- `updateExperiencePoints()` ‚Üí M√©thode d'instance
- `getCharacterEquipment()` ‚Üí M√©thode d'instance
- `getCharacterSpells()` ‚Üí M√©thode d'instance
- `getCharacterPoisons()` ‚Üí M√©thode d'instance
- `getStartingEquipmentCount()` ‚Üí M√©thode d'instance
- `updateProfilePhoto()` ‚Üí M√©thode d'instance

### M√©thodes supprim√©es

‚úÖ **Supprim√©es** :
- `getMyEquipment()` ‚Üí Remplac√©e par `getCharacterEquipment()`
- `equipItemStatic()` ‚Üí Non utilis√©e, supprim√©e
- Getters redondants : `getName()`, `getLevel()`, `getRaceId()`, `getBackgroundId()`, `getExperiencePoints()`, `getHitPointsMax()`, `getHitPointsCurrent()`

---

## ‚úÖ Points positifs

1. **Bonne s√©paration des responsabilit√©s** : Les m√©thodes li√©es aux classes ont √©t√© d√©plac√©es vers `Classe.php`
2. **Am√©lioration de l'encapsulation** : Conversion de nombreuses m√©thodes statiques en m√©thodes d'instance
3. **Coh√©rence am√©lior√©e** : Utilisation de m√©thodes d'instance pour les op√©rations sur le personnage
4. **Documentation** : La plupart des m√©thodes ont des commentaires PHPDoc

---

## üìù Notes finales

La classe `Character` a √©t√© significativement am√©lior√©e depuis la derni√®re analyse. Elle est maintenant plus orient√©e objet et mieux organis√©e. Cependant, il reste quelques points √† am√©liorer pour atteindre une parfaite coh√©rence.

**Score global** : 8/10
- ‚úÖ Architecture orient√©e objet : Bonne
- ‚ö†Ô∏è Coh√©rence du code : √Ä am√©liorer
- ‚úÖ Documentation : Correcte
- ‚ö†Ô∏è Redondances : Quelques redondances mineures
- ‚úÖ S√©paration des responsabilit√©s : Excellente apr√®s refactoring
