# üîó Association de lieux √† la campagne - Documentation

## üìã **Fonctionnalit√© ajout√©e**

Remplacement des boutons "Nouveau pays", "Nouvelle r√©gion", "Nouveau lieu" par un bouton "Associer un lieu" qui permet de rechercher et ajouter des lieux existants du monde √† la campagne.

---

## üîß **Modifications apport√©es**

### **1. Interface utilisateur**

#### **Boutons remplac√©s :**
```html
<!-- AVANT -->
<div class="btn-group" role="group">
    <button class="btn btn-brown btn-sm" data-bs-toggle="modal" data-bs-target="#createCountryModal">
        <i class="fas fa-globe"></i> Nouveau Pays
    </button>
    <button class="btn btn-brown btn-sm" data-bs-toggle="modal" data-bs-target="#createRegionModal">
        <i class="fas fa-map-marker-alt"></i> Nouvelle r√©gion
    </button>
    <button class="btn btn-brown btn-sm" data-bs-toggle="modal" data-bs-target="#createSceneModal">
        <i class="fas fa-plus"></i> Nouveau lieu
    </button>
</div>

<!-- APR√àS -->
<button class="btn btn-brown btn-sm" data-bs-toggle="modal" data-bs-target="#associatePlaceModal">
    <i class="fas fa-link"></i> Associer un lieu
</button>
```

### **2. Logique PHP ajout√©e**

#### **R√©cup√©ration des lieux disponibles :**
```php
// R√©cup√©rer les lieux disponibles dans le monde de la campagne (pour l'association)
$available_places = [];
if (isDMOrAdmin() && !empty($campaign['world_id'])) {
    $stmt = $pdo->prepare("
        SELECT p.id, p.name, p.description, p.notes, p.map_url, 
               c.name as country_name, r.name as region_name
        FROM places p
        LEFT JOIN countries c ON p.country_id = c.id
        LEFT JOIN regions r ON p.region_id = r.id
        WHERE c.world_id = ? AND p.campaign_id IS NULL
        ORDER BY c.name, r.name, p.name
    ");
    $stmt->execute([$campaign['world_id']]);
    $available_places = $stmt->fetchAll();
}
```

#### **Traitement de l'association :**
```php
// Gestion de l'association d'un lieu √† la campagne (MJ/Admin uniquement)
if (isset($_POST['action']) && $_POST['action'] === 'associate_place' && isDMOrAdmin()) {
    $place_id = (int)($_POST['place_id'] ?? 0);
    
    if ($place_id > 0) {
        try {
            // V√©rifier que le lieu appartient au monde de la campagne et n'est pas d√©j√† associ√©
            $stmt = $pdo->prepare("
                SELECT p.id FROM places p
                LEFT JOIN countries c ON p.country_id = c.id
                WHERE p.id = ? AND c.world_id = ? AND p.campaign_id IS NULL
            ");
            $stmt->execute([$place_id, $campaign['world_id']]);
            $place = $stmt->fetch();
            
            if ($place) {
                // Associer le lieu √† la campagne
                $stmt = $pdo->prepare("UPDATE places SET campaign_id = ? WHERE id = ?");
                $stmt->execute([$campaign_id, $place_id]);
                $success_message = "Lieu associ√© √† la campagne avec succ√®s.";
                
                // Recharger les lieux de la campagne
                $places = getPlacesWithGeography($campaign_id);
            } else {
                $error_message = "Ce lieu ne peut pas √™tre associ√© √† cette campagne.";
            }
        } catch (PDOException $e) {
            $error_message = "Erreur lors de l'association du lieu: " . $e->getMessage();
        }
    } else {
        $error_message = "Lieu invalide s√©lectionn√©.";
    }
}
```

### **3. Modal d'association**

#### **Structure du modal :**
```html
<!-- Modal Associer un lieu -->
<div class="modal fade" id="associatePlaceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Associer un lieu √† la campagne</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <form method="POST">
                <div class="modal-body">
                    <input type="hidden" name="action" value="associate_place">
                    
                    <!-- Contenu conditionnel selon l'√©tat -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-brown">
                        <i class="fas fa-link me-2"></i>Associer le lieu
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
```

#### **√âtats du modal :**

**1. Aucun monde d√©fini :**
```html
<div class="alert alert-warning">
    <i class="fas fa-exclamation-triangle me-2"></i>
    <strong>Attention :</strong> Aucun monde n'est d√©fini pour cette campagne. 
    Veuillez d'abord s√©lectionner un monde dans la zone "Monde" pour pouvoir associer des lieux.
</div>
```

**2. Aucun lieu disponible :**
```html
<div class="alert alert-info">
    <i class="fas fa-info-circle me-2"></i>
    <strong>Information :</strong> Aucun lieu disponible dans le monde "<?php echo htmlspecialchars($campaign['world_name']); ?>".
    Tous les lieux de ce monde sont d√©j√† associ√©s √† des campagnes ou il n'y a pas encore de lieux cr√©√©s.
</div>
```

**3. Lieux disponibles :**
```html
<div class="row g-3">
    <?php foreach ($available_places as $place): ?>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="place_id" 
                               id="place_<?php echo $place['id']; ?>" 
                               value="<?php echo $place['id']; ?>">
                        <label class="form-check-label w-100" for="place_<?php echo $place['id']; ?>">
                            <!-- Informations du lieu -->
                        </label>
                    </div>
                </div>
            </div>
        </div>
    <?php endforeach; ?>
</div>
```

---

## üéØ **Fonctionnalit√©s**

### **Recherche et s√©lection :**
- ‚úÖ **Filtrage** : Seuls les lieux du monde de la campagne sont affich√©s
- ‚úÖ **Disponibilit√©** : Seuls les lieux non associ√©s (`campaign_id IS NULL`) sont propos√©s
- ‚úÖ **Affichage** : Informations compl√®tes (nom, pays, r√©gion, description, plan)
- ‚úÖ **S√©lection** : Interface radio button pour choisir un lieu

### **Association :**
- ‚úÖ **Validation** : V√©rification de la propri√©t√© du monde et de la disponibilit√©
- ‚úÖ **S√©curit√©** : Seuls les MJ/Admin peuvent associer des lieux
- ‚úÖ **Mise √† jour** : Rechargement automatique de la liste des lieux
- ‚úÖ **Feedback** : Messages de succ√®s/erreur appropri√©s

### **Interface :**
- ‚úÖ **Responsive** : Modal en largeur (`modal-lg`) avec grille adaptative
- ‚úÖ **Visuel** : Cartes avec images miniatures des plans
- ‚úÖ **Navigation** : Boutons d'annulation et de validation
- ‚úÖ **√âtats** : Gestion des cas d'erreur et d'information

---

## üîç **Logique de filtrage**

### **Requ√™te SQL :**
```sql
SELECT p.id, p.name, p.description, p.notes, p.map_url, 
       c.name as country_name, r.name as region_name
FROM places p
LEFT JOIN countries c ON p.country_id = c.id
LEFT JOIN regions r ON p.region_id = r.id
WHERE c.world_id = ? AND p.campaign_id IS NULL
ORDER BY c.name, r.name, p.name
```

### **Conditions :**
- **`c.world_id = ?`** : Le lieu doit appartenir au monde de la campagne
- **`p.campaign_id IS NULL`** : Le lieu ne doit pas √™tre d√©j√† associ√© √† une campagne
- **Tri** : Par pays, puis r√©gion, puis nom du lieu

---

## üõ°Ô∏è **S√©curit√©**

### **Authentification :**
- ‚úÖ **Connexion requise** : Utilisateur connect√© obligatoire
- ‚úÖ **Permissions** : Seuls les MJ/Admin peuvent associer des lieux

### **Validation :**
- ‚úÖ **Propri√©t√© du monde** : V√©rification que le lieu appartient au monde de la campagne
- ‚úÖ **Disponibilit√©** : V√©rification que le lieu n'est pas d√©j√† associ√©
- ‚úÖ **Int√©grit√©** : Validation de l'ID du lieu et de la campagne

### **Protection :**
- ‚úÖ **SQL Injection** : Requ√™tes pr√©par√©es
- ‚úÖ **XSS** : √âchappement HTML des donn√©es affich√©es
- ‚úÖ **CSRF** : Formulaire POST avec validation c√¥t√© serveur

---

## üìä **Donn√©es g√©r√©es**

### **Informations des lieux :**
- **`id`** : Identifiant unique du lieu
- **`name`** : Nom du lieu
- **`description`** : Description du lieu
- **`notes`** : Notes additionnelles
- **`map_url`** : URL de l'image du plan
- **`country_name`** : Nom du pays
- **`region_name`** : Nom de la r√©gion

### **Relations :**
- **Lieu ‚Üí Campagne** : Association via `campaign_id`
- **Lieu ‚Üí Monde** : Via pays (`country.world_id`)
- **Unicit√©** : Un lieu ne peut √™tre associ√© qu'√† une campagne

---

## üé® **Design et UX**

### **Interface :**
- **Modal large** : `modal-lg` pour afficher les cartes c√¥te √† c√¥te
- **Grille responsive** : `col-md-6` pour 2 colonnes sur desktop
- **Cartes uniformes** : `h-100` pour une hauteur √©gale
- **Images miniatures** : 60x60px avec `object-fit: cover`

### **Navigation :**
- **Bouton principal** : Ic√¥ne `fa-link` pour l'association
- **Boutons modal** : Annuler (secondary) et Associer (brown)
- **√âtats visuels** : Alerts pour les cas d'erreur/information

### **Accessibilit√© :**
- **Labels** : Association correcte des labels aux inputs radio
- **ARIA** : Attributs `aria-label` sur les boutons
- **Contraste** : Couleurs Bootstrap standard

---

## üìã **Workflow utilisateur**

### **Pour un MJ :**
1. **Acc√©der** √† `view_campaign.php?id=X`
2. **V√©rifier** qu'un monde est d√©fini pour la campagne
3. **Cliquer** sur "Associer un lieu"
4. **Voir** la liste des lieux disponibles du monde
5. **S√©lectionner** un lieu via le bouton radio
6. **Cliquer** sur "Associer le lieu"
7. **Confirmer** le message de succ√®s

### **Cas d'erreur :**
- **Pas de monde** : Message d'avertissement avec instruction
- **Pas de lieux** : Message d'information explicatif
- **Erreur technique** : Message d'erreur avec d√©tails

---

## ‚úÖ **Avantages**

### **Simplicit√© :**
- **Un seul bouton** au lieu de trois
- **Interface claire** avec s√©lection visuelle
- **Workflow lin√©aire** sans √©tapes multiples

### **Coh√©rence :**
- **R√©utilisation** des lieux existants du monde
- **Hi√©rarchie respect√©e** : Monde ‚Üí Pays ‚Üí R√©gion ‚Üí Lieu
- **Pas de duplication** de contenu g√©ographique

### **Flexibilit√© :**
- **Association optionnelle** : Les lieux peuvent rester libres
- **R√©utilisation** : Un lieu peut √™tre associ√© √† diff√©rentes campagnes
- **Gestion centralis√©e** : Cr√©ation des lieux dans le syst√®me de mondes

---

## üéâ **R√©sultat**

### **Fonctionnalit√© compl√®te :**
- ‚úÖ **Interface** : Bouton unique "Associer un lieu"
- ‚úÖ **Recherche** : Filtrage des lieux par monde et disponibilit√©
- ‚úÖ **S√©lection** : Interface visuelle avec cartes et images
- ‚úÖ **Association** : Logique de validation et mise √† jour
- ‚úÖ **S√©curit√©** : Permissions et validation appropri√©es
- ‚úÖ **UX** : Gestion des √©tats d'erreur et d'information

**üîó Le syst√®me d'association de lieux est maintenant op√©rationnel ! Les MJ peuvent facilement associer des lieux existants de leur monde √† leurs campagnes.**
